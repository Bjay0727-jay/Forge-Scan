# ForgeScan Agent - Multi-stage build for minimal image size
#
# Build: docker build -f Dockerfile.agent -t forgescan-agent .
# Run:   docker run -it --rm forgescan-agent --scan-now

# Stage 1: Build environment
FROM rust:1.75-slim-bookworm AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy manifests first for better layer caching
COPY Cargo.toml Cargo.lock ./
COPY crates ./crates
COPY proto ./proto
COPY checks ./checks

# Build release binary
RUN cargo build --release --bin forgescan-agent

# Stage 2: Runtime image (distroless for minimal attack surface)
FROM gcr.io/distroless/cc-debian12:latest

# Copy the binary
COPY --from=builder /app/target/release/forgescan-agent /usr/local/bin/forgescan-agent

# Copy default checks
COPY --from=builder /app/checks /etc/forgescan/checks

# Set default config location
ENV FORGESCAN_CONFIG=/etc/forgescan/agent.toml

# Expose no ports (agent connects outbound only)

# Run as non-root
USER nonroot:nonroot

ENTRYPOINT ["/usr/local/bin/forgescan-agent"]
CMD ["--help"]

# Labels
LABEL org.opencontainers.image.title="ForgeScan Agent"
LABEL org.opencontainers.image.description="Lightweight endpoint security agent for configuration auditing"
LABEL org.opencontainers.image.vendor="Forge Cyber Defense"
LABEL org.opencontainers.image.source="https://github.com/forge-cyber/forgescan"
